#!/opt/tsmart-date/tbash
set -eu
. $(dirname "$0")/lib-common

sym-fuzz() {
    local KLEE_ARGS=(
        "-only-output-states-covering-new"
        "-libc=uclibc"
        "-posix-runtime"
        "-simplify-sym-indices"
    )

    local arg_max_memory="${MAX_MEM:-2000}"
    app_bc_path="$1"

    log-debug "Symbolic argument size = $SYM_ARG_SIZE"
    log-debug "Application is at $app_bc_path"

    log-info "Starting symbolic execution"
    klee_args+=(
        "-max-instruction-time=30"
        "-max-memory=$arg_max_memory"
        "-max-sym-array-size=4096"
    )

    args=("$KLEE" "${KLEE_ARGS[@]}" "$app_bc_path" -sym-arg "$SYM_ARG_SIZE")
    print-args "KLEE cmdline:" "${args[@]}"
    "${args[@]}"
}

dyn-fuzz() {
    # TODO more afl tuning here
    local args=("$AFL_PREFIX/bin/afl-fuzz" "-m 20981520" "$@")
    print-args "AFL cmdline:" "${args[@]}"
    "${args[@]}"
}

usage() {
    local prog="$(basename "$0")"
    log-error "Usage\n" \
              "    $prog app\n"
}

[[ "$#" == 0 ]] && usage

load-config
if [[ "$MODE" == sym ]]; then
    . $(dirname "$0")/lib-sym
    sym-fuzz "$1.bc"
else
    . $(dirname "$0")/lib-dyn
    dyn-fuzz "$@"
fi
